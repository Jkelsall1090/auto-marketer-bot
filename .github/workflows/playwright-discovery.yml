name: Social Media Discovery

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      campaign_id:
        description: 'Campaign ID to run discovery for (required)'
        required: true
        type: string
      campaign_name:
        description: 'Campaign name for logging'
        required: false
        default: 'Manual Run'
        type: string
      campaign_product:
        description: 'Product/service keywords to search for'
        required: false
        default: 'marketing automation'
        type: string
      platforms:
        description: 'Platforms to discover (comma-separated: reddit,linkedin,facebook,nextdoor)'
        required: false
        default: 'reddit'
        type: string

jobs:
  discover:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright
        run: |
          cd scripts/playwright-discovery
          npm install
          npx playwright install chromium --with-deps

      - name: Run Discovery
        env:
          # Webhook configuration (no database access needed)
          WEBHOOK_URL: https://rqvdxclxoasdjvuwvngm.supabase.co/functions/v1/discovery-webhook
          DISCOVERY_WEBHOOK_SECRET: ${{ secrets.DISCOVERY_WEBHOOK_SECRET }}
          # Campaign configuration
          CAMPAIGN_ID: ${{ github.event.inputs.campaign_id }}
          CAMPAIGN_NAME: ${{ github.event.inputs.campaign_name || 'Default Campaign' }}
          CAMPAIGN_PRODUCT: ${{ github.event.inputs.campaign_product || 'marketing automation' }}
          PLATFORMS: ${{ github.event.inputs.platforms || 'reddit' }}
          # Optional platform credentials (add as GitHub Secrets if needed)
          REDDIT_USERNAME: ${{ secrets.REDDIT_USERNAME }}
          REDDIT_PASSWORD: ${{ secrets.REDDIT_PASSWORD }}
          LINKEDIN_EMAIL: ${{ secrets.LINKEDIN_EMAIL }}
          LINKEDIN_PASSWORD: ${{ secrets.LINKEDIN_PASSWORD }}
          FACEBOOK_EMAIL: ${{ secrets.FACEBOOK_EMAIL }}
          FACEBOOK_PASSWORD: ${{ secrets.FACEBOOK_PASSWORD }}
          NEXTDOOR_EMAIL: ${{ secrets.NEXTDOOR_EMAIL }}
          NEXTDOOR_PASSWORD: ${{ secrets.NEXTDOOR_PASSWORD }}
        run: |
          cd scripts/playwright-discovery
          npm run discover

      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-screenshots
          path: scripts/playwright-discovery/screenshots/
          retention-days: 7
